<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Set Alert</title>
    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <!-- Vue -->
    <script src="https://unpkg.com/vue@next"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
    <!-- icons  -->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <!-- axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!--moment-->
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <!--css-->
    <link rel="stylesheet" href="css/alert.css">
    <link rel="stylesheet" href="css/global.css">
    <!--tooltip-->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6.3.0/dist/tippy.css">
    <script src="https://unpkg.com/tippy.js@6.3.0/dist/tippy.all.umd.min.js"></script>
    <!-- AOS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!--Chatbot-->                
    <script type='text/javascript'>
		(function(I, L, T, i, c, k, s) {if(I.iticks) return;I.iticks = {host:c, settings:s, clientId:k, cdn:L, queue:[]};var h = T.head || T.documentElement;var e = T.createElement(i);var l = I.location;e.async = true;e.src = (L||c)+'/client/inject-v2.min.js';h.insertBefore(e, h.firstChild);I.iticks.call = function(a, b) {I.iticks.queue.push([a, b]);};})(window, 'https://cdn-v1.intelliticks.com/prod/common', document, 'script', 'https://app.intelliticks.com', 'PNYC9pEHDGnxainri_c', {});
    </script>
    <style>
        body {
            background-color: #a8e0c3;
        }
    </style>


</head>
                
<body class="sb-nav-fixed">
    <div id="app">
        <div>
            <nav class="navbar navbar-expand-lg navbar-dark bg-success" id="navbar">
                <div class="container-fluid">
                    <a class="navbar-brand" href="afterloginhome.html">
                        <i class="fas fa-heartbeat customSize"></i>
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link" href="afterloginhome.html">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="trackerDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                    Tracker
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="trackerDropdown">
                                    <li><a class="dropdown-item" href="bloodpressure.html">Blood Pressure Tracker</a>
                                    </li>
                                    <li><a class="dropdown-item" href="bloodglucose.html">Blood Glucose Tracker</a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="alert.html">Notification</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="map.html">Map</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="forum.html">Forum</a>
                            </li>
                        </ul>

                        <ul class="navbar-nav d-flex flex-row ms-auto me-3">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button"
                                    data-bs-toggle="dropdown" aria-expanded="false"><i
                                        class="fas fa-user fa-fw"></i></a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" @click="logout()">Logout</a></li>
                                </ul>

                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>

        <!-- JUMBOTRON -->
        <div class="p-2 pt-5 bg-success">
            <div class="container-fluid py-5">
                <h1 class="display-8 fw-bold" style="text-align: center; color:white">Set a Notification</h1>
                <p class="fs-5" style="text-align: center;color:white">Need to set a notification to remind you of your
                    medicial appointment? Look no further!<br> Create and keep track of notifications here which sends
                    you a message on telegram! <br>**Remember to start the HealthBuddy Bot to recieve the message.</p>
            </div>
        </div>
        <!-- JUMBOTRON -->

        <div>
            <main>
                <div class="container-fluid px-4">
                    <h1 class="mt-4">Create a Notification</h1>
                    <div class="card mb-4" style="background-color: #a8e0c3">
                        <div class="card-body">
                            <form @submit.prevent="submitEntry">
                                <div class="row mb-3">
                                    <div class="col-lg-6 col-md-6 col-sm-6 col-6">
                                        <div class="form-floating mb-3 mb-md-0">
                                            <input class="form-control" id="datetime" type="datetime-local"
                                                placeholder="" v-model="datetime" required :min="currentDatetime" />
                                            <label for="datetime">Date & Time of Alert</label>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-6 col-sm-6 col-6">
                                        <div class="form-floating mb-3 mb-md-0">
                                            <input class="form-control" id="TeleID" type="text" placeholder=""
                                                v-model="TeleID" required />
                                            <label for="TeleID">Telegram ID</label>
                                        </div>
                                        <span class="info-icon" @mouseover="showTelegramIdInfo">â„¹</span>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-lg-6 col-md-6 col-sm-6 col-6">
                                        <!-- Frequency -->
                                        <div class="form-floating mb-3 mb-md-0">
                                            <input class="form-control" id="frequency" type="number" placeholder=""
                                                v-model="frequency" required />
                                            <label for="frequency">Frequency</label>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-6 col-sm-6 col-6">
                                        <!-- Frequency Type -->
                                        <select class="form-select" id="frequencyType" v-model="frequencyType" required style="height: 60px;">
                                            <option value="days">Daily</option>
                                            <option value="weeks">Weekly</option>
                                            <option value="months">Monthly</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-12">
                                        <div class="form-floating mb-3 mb-md-0">
                                            <input class="form-control" id="Msg" type="text" placeholder=""
                                                v-model="Msg" required style="height: 100px;" />
                                            <label for="Msg">Message</label>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Submit</button>
                            </form>
                        </div>
                    </div>

                    <h1 class="mt-4">Notification Records</h1>
                    <!-- alert component -->
                    <div class="row">
                        <div class="d-flex flex-wrap">
                            <div v-for='(alert, idx) in alertList' class="custom-alert-col" :key='idx'>
                                <div class="mb-3">
                                    <alert-tracker :alert='alert' :idx='idx' :class="alertBackgroundColorClass(idx)"
                                        @delete="deleteAlert">
                                    </alert-tracker>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer-basic aos-init aos-animate" data-aos="fade-in" data-aos-duration="1500">
        <footer>
            <div class="social text-dark fw-bold" id="app5">
                Logged in as: {{currentUser.fName + " " +currentUser.lName}}
            </div>
            <div class="social">
                <a href="#">
                    <iconify-icon icon="ion:logo-apple-appstore"></iconify-icon>
                </a>
                <a href="#">
                    <iconify-icon icon="ion:logo-google-playstore"></iconify-icon>
                </a>
                <a href="#">
                    <iconify-icon icon="ion:logo-instagram"></iconify-icon>
                </a>
            </div>
            <p class="copyright">HealthBuddy &copy; IS216</p>
        </footer>
    </div>

    <!-- AOS -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>AOS.init();</script>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
</body>

</html>


<script>
    // Initialize Firebase 
    const firebaseConfig = {
        databaseURL: "https://wad2-project-577ea-default-rtdb.asia-southeast1.firebasedatabase.app",
        apiKey: "AIzaSyDWR7cQApDtFlD2wx5Btku67Bhg8_xwsUg",
        authDomain: "wad2-project-577ea.firebaseapp.com",
        projectId: "wad2-project-577ea",
        storageBucket: "wad2-project-577ea.appspot.com",
        messagingSenderId: "878918082978",
        appId: "1:878918082978:web:250e7cfd55234ea00012fb",
        measurementId: "G-SLGD98DFQ5"
    };
    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    var table;

    const app = Vue.createApp({
        data() {
            return {
                currentUser: null,
                entries: [],
                datetime: "",
                TeleID: "",
                Msg: "",
                frequencyType: "days",
                alertList: [],
                currentDatetime: (moment().add(1, 'minutes')).format("YYYY-MM-DDTHH:mm"),
                frequency:""
            }
        },
        methods: {
            async submitEntry() {
                const frequency = parseInt(document.getElementById("frequency").value);
                const frequencyType = document.getElementById("frequencyType").value;

                // Get the selected date and time
                const selectedDatetime = this.datetime;

                // Create an array to store duplicate dates
                const duplicateDates = [];

                // Calculate duplicate dates based on frequency and type
                const startDate = moment(selectedDatetime);
                for (let i = 0; i < frequency; i++) {
                    duplicateDates.push(startDate.format("YYYY-MM-DDTHH:mm"));
                    if (frequencyType === "days") {
                        startDate.add(1, "days");
                    } else if (frequencyType === "weeks") {
                        startDate.add(1, "weeks");
                    } else if (frequencyType === "months") {
                        startDate.add(1, "months");
                    }
                }

                // Insert the duplicate alert entries into the database
                const userRef = database.ref('alerts/' + this.currentUser.userKey + '/alertEntries');
                for (const date of duplicateDates) {
                    const newEntryRef = userRef.push();
                    await newEntryRef.set({
                        Msg: this.Msg,
                        TeleID: this.TeleID,
                        datetime: date,
                    });
                    this.alertList.push({ 'Msg': this.Msg, 'TeleID': this.TeleID, 'datetime': date})
                }                
                // Clear input fields
                this.Msg = "";
                this.TeleID = "";
                this.datetime = "";
                this.frequency = "";
                this.frequencyType = "";
            },
            logout() {
                localStorage.removeItem("user");
                window.location.href = "index.html";
            },

            async getAlerts() {
                try {
                    const userRef = database.ref('alerts/' + this.currentUser.userKey + '/alertEntries');
                    const snapshot = await userRef.once('value');
                    const alertData = snapshot.val();

                    if (alertData) {
                        const alertList = Object.values(alertData);
                        this.alertList = alertList;
                    }
                } catch (error) {
                    console.error('Error fetching alert data:', error);
                }
            },

            async getEntries() {
                var ref = database.ref("alerts/" + this.currentUser.userKey + "/alertEntries");
                let snapshot = await ref.once('value')
                this.entries = snapshot.val();
            },
            async deleteAlert(index) {
                try {
                    const ref = database.ref('alerts/' + currentUser.userKey + '/alertEntries');
                    const snapshot = await ref.once('value');
                    const entries = snapshot.val();
                    const recordKeys = Object.keys(entries);
                    const rKey = recordKeys[index];
                    const recordRef = database.ref('alerts/' + currentUser.userKey + '/alertEntries/' + rKey);

                    await recordRef.remove();

                    // Update the alertList in Vue component
                    this.alertList.splice(index, 1); // Remove the alert from the list
                    console.log('Record deleted successfully.');
                } catch (error) {
                    console.error('Error deleting record:', error);
                }
            },
            isDateInPast(date) {
                const currentDate = moment();
                const alertDate = moment(date);
                return alertDate.isBefore(currentDate);
            },
            showTelegramIdInfo() {
                alert("To get your Telegram ID, you can use Telegram Bot Raw on Telegram and copy the ChatID.\n\nIf you are looking for a group Telegram ID, head over to the Telegram Web on your browser, select on the group and copy the numbers after the '#'. Make sure to include the -/+ signs if given.");
            },
        },
        computed: {
            alertBackgroundColorClass() {
                return (index) => {
                    const date = this.alertList[index].datetime;
                    if (this.isDateInPast(date)) {
                        return 'alert-past'; // CSS class for past dates (e.g., pink background)
                    } else {
                        return 'alert-future'; // CSS class for future dates (e.g., blue background)
                    }
                };
            },
        },
        created() {
            this.currentUser = JSON.parse(localStorage.getItem("user"));
            if (!this.currentUser) {
                // Redirect to the login page
                window.location.href = "login.html";
            };
            this.getEntries();
            this.getAlerts();
        }
    });
    app.component('alert-tracker', {
        props: ['alert', 'idx'],
        methods: {
            deleteAlertEntry() {
                this.$emit('delete', this.idx);
            }
        },
        template: `
            <div class="card" style="width: 21rem;display:inline-block;">
            <div class="card-body">
                <h5 class="card-title">Time of Alert: {{alert.datetime}}</h5>
                <hr>
                <p class="card-text">Telegram ID: {{alert.TeleID}}</p>
                <p class="card-text">Message: {{alert.Msg}}</p>
                <button type="button" @click="deleteAlertEntry" class="btn btn-danger">Delete</button>
            </div>
            </div>
            `
    })

    const vm = app.mount("#app")

    let entries = [];
    let recordKeys = [];
    let currentUser = JSON.parse(localStorage.getItem("user"));
    console.log(currentUser);

    async function getData() {
        var ref = database.ref("alerts/" + currentUser.userKey + "/alertEntries");
        let snapshot = await ref.once('value')
        entries2 = snapshot.val();
        let entriesArr = Object.values(entries2);
        return entriesArr
    }
</script>
<script>
    function convertAndFilter(entriesArr) {
        const entriesArrobj = JSON.parse(JSON.stringify(entriesArr))
        const now = moment();
        const previousMinute = now.clone().subtract(1, 'minutes');
        const currentTime = now;
        console.log('previousMinute', previousMinute.format());
        console.log('currentTime', currentTime.format());
        return entriesArrobj.filter(row => {
            const scheduleDatetime = moment(row['datetime']);
            return scheduleDatetime.isAfter(previousMinute) && scheduleDatetime.isBefore(currentTime);
        });
    }

    async function sendMessage(row) {
        const bot_id = "6842993088:AAGqiVSlwx9aaXLAx6Mp1CNblPMUIMqP6bs";
        const chat_id = row['TeleID'];
        const message = row['Msg'];
        const url = `https://api.telegram.org/bot${bot_id}/sendMessage?chat_id=${chat_id}&text=${message}`;

        try {
            const response = await axios.get(url);
            console.log(response.data);
            return response.data;
        } catch (error) {
            console.error(error);
        }
    }

    async function processData() {
        try {
            const data = await getData();
            const filteredData = convertAndFilter(data);
            if (filteredData.length > 0) {
                const statuses = await Promise.all(filteredData.map(sendMessage));
                console.log(statuses);
            }
        } catch (error) {
            console.error(error);
        }
    }

    (async function () {
        try {
            while (true) {
                await processData();
                console.log('Waiting for 60 seconds...');
                await new Promise(resolve => setTimeout(resolve, 60000));
            }
        } catch (error) {
            console.error(error);
        }
    })();

    const app10 = Vue.createApp({
        data() {
            return {
                currentUser: null,
            }
        },
        created() {
            this.currentUser = JSON.parse(localStorage.getItem("user"));
        },
    }).mount("#app5");
</script> 